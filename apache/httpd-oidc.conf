<VirtualHost *:8443>
    
    ServerName localhost
    
    SSLEngine on

    SSLCertificateFile /etc/httpd/tls/localhost.crt
    SSLCertificateKeyFile /etc/httpd/tls/localhost.key

    # OIDC Configuration
    # Use internal HTTPS URL for metadata fetch (Apache can reach this from container)
    OIDCProviderMetadataURL https://keycloak:8443/realms/demo/.well-known/openid-configuration
    # Override endpoints to use internal HTTPS URLs for backend operations
    OIDCProviderTokenEndpoint https://keycloak:8443/realms/demo/protocol/openid-connect/token
    OIDCProviderUserInfoEndpoint https://keycloak:8443/realms/demo/protocol/openid-connect/userinfo
    OIDCProviderJwksUri https://keycloak:8443/realms/demo/protocol/openid-connect/certs
    # But use external HTTPS URL for authorization endpoint (browser redirects)
    OIDCProviderAuthorizationEndpoint https://localhost/realms/demo/protocol/openid-connect/auth
    OIDCClientID quarkus-app
    OIDCClientSecret your-client-secret-here
    OIDCRedirectURI https://localhost:8443/redirect_uri
    OIDCCryptoPassphrase a-random-secret-key-change-this-in-production
    # SSL validation for HTTPS
    OIDCSSLValidateServer off
    
    # Proxy to Quarkus application
    ProxyPass /user http://quarkus-app:8080/user
    ProxyPassReverse /user http://quarkus-app:8080/user
    
    # OIDC Redirect URI handler
    <Location /redirect_uri>
        AuthType openid-connect
        Require valid-user
    </Location>
    
    # Location for OIDC protected endpoint
    <Location /user>
        AuthType openid-connect
        Require valid-user
        
        # Pass user ID to backend
        RequestHeader set X-User-Id "%{OIDC_CLAIM_preferred_username}e"
    </Location>

</VirtualHost>